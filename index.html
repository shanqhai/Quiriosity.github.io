<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiriosity</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee&family=Outfit:wght@400;700&display=swap');
        :root { --bg: #0f0f0f; --card: #1a1a1a; --red: #ff4757; --yellow: #ffcc00; --white: #ffffff; --green: #2ecc71; --orange: #ffa502; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--white); font-family: 'Outfit', sans-serif; margin: 0; height: 100dvh; width: 100vw; overflow: hidden; }
        .app-shell { background: var(--card); width: 100%; height: 100%; border: 4px solid var(--red); display: flex; flex-direction: column; }
        .theme-solar { border-color: var(--orange) !important; --red: var(--orange); }
        .theme-power { border-color: var(--green) !important; --red: var(--green); }
        .header { background: var(--red); padding: 10px; text-align: center; border-bottom: 4px solid var(--yellow); flex-shrink: 0; }
        .logo { font-family: 'Bungee'; font-size: 1.5rem; color: var(--yellow); text-shadow: 2px 2px 0px #000; margin: 0; }
        .view { display: none; flex: 1; padding: 15px; overflow: hidden; flex-direction: column; }
        .active { display: flex; }
        .split-layout { display: flex; flex: 1; gap: 20px; overflow: hidden; }
        .side-bar { width: 350px; display: flex; flex-direction: column; border-right: 2px solid #333; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .scroll-area { flex: 1; overflow-y: auto; padding-right: 10px; }
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-thumb { background: var(--yellow); border-radius: 10px; }
        #game-canvas { height: 150px; background: #000; border-radius: 20px; margin-bottom: 15px; display: flex; justify-content: center; align-items: center; font-size: 4rem; border: 3px dashed #333; }
        .editor-box { background: #111; padding: 15px; border-radius: 15px; border: 1px solid #444; margin-bottom: 10px; }
        button { font-family: 'Bungee'; border: none; padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .btn-yellow { background: var(--yellow); color: #000; width: 100%; }
        .btn-red { background: var(--red); color: #fff; width: 100%; }
        .btn-ghost { background: transparent; border: 2px solid var(--yellow); color: var(--yellow); width: 100%; }
        .list-item { background: #222; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; margin-bottom: 8px; border-left: 5px solid var(--yellow); align-items: center; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .opt-btn { background: #333; color: white; border: 2px solid #444; padding: 20px; font-size: 1rem; }
        input { padding: 12px; background: #000; border: 2px solid #333; color: white; border-radius: 10px; width: 100%; margin-bottom: 8px; }
        .progress-track { background: #333; height: 15px; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        .p-fill { height: 100%; background: var(--yellow); width: 0%; transition: 0.5s; }
        .del-btn { background: #441111; color: #ff4757; padding: 5px 10px; border: 1px solid #ff4757; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="app-shell" id="main-shell">
    <div class="header"><h1 class="logo">QUIRIOSITY</h1></div>

    <div id="view-home" class="view active">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; gap:20px; max-width:500px; margin:0 auto; width:100%;">
            <button class="btn-yellow" style="height:150px; font-size:2rem;" onclick="nav('view-join')">STUDENT LOGIN</button>
            <button class="btn-red" style="height:150px; font-size:2rem;" onclick="nav('view-dash')">TEACHER DASHBOARD</button>
        </div>
    </div>

    <div id="view-dash" class="view">
        <div class="split-layout">
            <div class="side-bar">
                <div class="scroll-area" style="padding-right:15px;">
                    <h2 style="font-family:'Bungee'; color:var(--yellow);">FOLDERS</h2>
                    <div class="editor-box">
                        <input type="text" id="new-cat" placeholder="Subject (e.g. STEM)">
                        <input type="text" id="new-sub" placeholder="Topic (e.g. Physics)">
                        <button class="btn-yellow" onclick="addFolder()">CREATE FOLDER</button>
                    </div>
                    <button class="btn-ghost" onclick="nav('view-home')">BACK TO HOME</button>
                </div>
            </div>
            <div class="main-content">
                <div class="scroll-area" id="folder-list"></div>
            </div>
        </div>
    </div>

    <div id="view-edit" class="view">
        <div class="split-layout">
            <div class="side-bar">
                <div class="scroll-area" style="padding-right:15px;">
                    <h2 id="edit-title" style="font-family:'Bungee'; color:var(--yellow); font-size:1.2rem; margin-top:0;"></h2>
                    <div class="editor-box">
                        <input type="text" id="add-q" placeholder="Question">
                        <input type="text" id="add-a" placeholder="Correct Answer">
                        <input type="text" id="add-w" placeholder="Wrong Answers (comma-sep) - LEAVE EMPTY FOR ID">
                        <button class="btn-yellow" onclick="saveQuestion()">SAVE QUESTION</button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-bottom:10px;">
                        <button onclick="setManualGame('Solar','theme-solar')" style="background:var(--orange); font-size:0.6rem;">SOLAR</button>
                        <button onclick="setManualGame('Power','theme-power')" style="background:var(--green); font-size:0.6rem;">POWER</button>
                        <button onclick="setManualGame('Pizza','')" style="background:var(--red); font-size:0.6rem;">PIZZA</button>
                    </div>
                    <input type="number" id="host-code" placeholder="4-DIGIT ROOM CODE">
                    <button class="btn-red" onclick="launchGame()" style="margin-bottom:10px;">LAUNCH ARENA</button>
                    <button class="btn-ghost" onclick="nav('view-dash')">BACK TO FOLDERS</button>
                </div>
            </div>
            <div class="main-content">
                <div class="scroll-area" id="q-list"></div>
            </div>
        </div>
    </div>

    <div id="view-lobby" class="view">
        <h2 id="room-display" style="text-align:center; font-family:'Bungee'; color:var(--yellow);">ROOM: --</h2>
        <div class="scroll-area" style="background:#111; border-radius:20px; padding:20px;">
            <table style="width:100%;"><tbody id="live-results"></tbody></table>
        </div>
        <button class="btn-red" style="margin-top:10px;" onclick="signalStart()">START SESSION</button>
    </div>

    <div id="view-arena" class="view">
        <div id="game-canvas">üçï</div>
        <div class="progress-track"><div id="p-bar" class="p-fill"></div></div>
        <div class="scroll-area" style="text-align:center;">
            <h2 id="q-text" style="font-size:1.8rem;">...</h2>
            <div id="input-zone" style="display:none; padding:20px;">
                <input type="text" id="ident-input" placeholder="Type answer here..." style="font-size:1.5rem; text-align:center;">
                <button class="btn-yellow" onclick="submitIdent()">SUBMIT</button>
            </div>
            <div id="opt-grid" class="opt-grid"></div>
        </div>
    </div>

    <div id="view-result" class="view">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <h1 style="font-family:'Bungee'; color:var(--yellow);">COMPLETE</h1>
            <div id="final-score" style="font-size:4rem; font-family:'Bungee';">0/0</div>
            <button class="btn-red" onclick="location.reload()">EXIT</button>
        </div>
    </div>

    <div id="view-join" class="view">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; max-width:400px; margin:0 auto; width:100%;">
            <input type="text" id="stu-name" placeholder="NICKNAME">
            <input type="number" id="stu-code" placeholder="ROOM CODE">
            <button class="btn-yellow" onclick="joinGame()">ENTER ARENA</button>
            <button class="btn-ghost" style="margin-top:10px;" onclick="nav('view-home')">BACK</button>
        </div>
    </div>
</div>

<script>
// FULL_DB and Logic remain exactly the same as previous version
const FULL_DB = {
    "Core Subjects": {
        "Effective Communication": [{q:"Identifying purpose helps determine if author wants to:", a:"Persuade, inform, or instruct", w:["Grammar","Visual Aids","Bias"]},{q:"Audience affects how the writer chooses:", a:"Word choice and level of formality", w:["Weather","Main idea","Deadline"]},{q:"Technical texts often avoid figurative language to:", a:"Provide clear and accurate information", w:["Emotional impact","Share opinions","Entertain teachers"]},{q:"Body language, facial expressions, and silence are examples of:", a:"Non-verbal communication", w:["Open listening","Pretend listening","Clarity listening"]},{q:"Exchanging messages between sender and receiver is:", a:"Communication", w:["Expression","Transmission","Interaction"]},{q:"Main purpose of feedback?", a:"To indicate if the message was understood", w:["To confuse sender","To entertain","To deliver new message"]},{q:"One of the best ways to show customers you are listening is:", a:"Appropriate eye contact", w:["Talking to others","Frowning","Asking to repeat"]},{q:"What is the nature of communication?", a:"It is dynamic and continuous", w:["Random","One-sided","Always uses words"]},{q:"Which function allows people to build relationships?", a:"Social Interaction", w:["Motivation","Information","Control"]},{q:"The 'barrier' in communication that refers to noise is:", a:"Physical barrier", w:["Semantic","Emotional","Cultural"]}],
        "General Mathematics": [{q:"Invest ‚Ç±1,000 and earn ‚Ç±50 interest. Total Maturity Value?", a:"‚Ç±1,050", w:["‚Ç±950","‚Ç±50","‚Ç±1,000"]},{q:"In simple interest formula I = Prt, what does 'r' stand for?", a:"Rate", w:["Real money","Ratio","Remaining"]},{q:"If you borrow money for 6 months, what value for 't' (years) is used?", a:"0.5", w:["6","1","12"]},{q:"Interest calculated on both principal and previous interest:", a:"Compound Interest", w:["Simple","Half","Flat"]},{q:"Person or institution that makes funds available is the:", a:"Lender", w:["Borrower","Debtor","Cashier"]},{q:"In Logic, a simple statement that is either true or false is a:", a:"Proposition", w:["Question","Exclamation","Instruction"]},{q:"Which logical connector uses the word 'AND'?", a:"Conjunction", w:["Disjunction","Negation","Implication"]},{q:"If a statement P is True, what is its Negation (Not P)?", a:"False", w:["True","Maybe","Both"]},{q:"What is the symbol for the logical connector 'OR'?", a:"‚à®", w:["‚àß","‚Üí","~"]},{q:"The sequence 2, 4, 8, 16 is an example of:", a:"Geometric Sequence", w:["Arithmetic","Fibonacci","Prime"]}],
        "General Science": [{q:"Which subsystem contains all the water on the planet?", a:"Hydrosphere", w:["Atmosphere","Geosphere","Biosphere"]},{q:"What is the thin, outermost layer of the Earth?", a:"Crust", w:["Mantle","Outer Core","Inner Core"]},{q:"Naturally occurring, inorganic solid with crystal structure:", a:"Mineral", w:["Rock","Fossil","Soil"]},{q:"Rock formed from cooling of lava or magma:", a:"Igneous Rock", w:["Sedimentary","Metamorphic","Sandstone"]},{q:"Process of rocks breaking down into smaller pieces:", a:"Weathering", w:["Erosion","Deposition","Compaction"]},{q:"Which planet is known as the 'Blue Planet'?", a:"Earth", w:["Mars","Venus","Neptune"]},{q:"What is the basic unit of life?", a:"Cell", w:["Atom","Tissue","Organ"]},{q:"Organisms that eat plants or other animals are:", a:"Consumers", w:["Producers","Decomposers","Predators"]},{q:"Process plants use to convert sunlight into energy:", a:"Photosynthesis", w:["Respiration","Digestion","Evaporation"]},{q:"Gas produced by plants that humans breathe in:", a:"Oxygen", w:["Carbon Dioxide","Nitrogen","Helium"]}],
        "Pag-aaral ng Kasaysayan at Lipunang Pilipino": [{q:"Pag-aaral ng lipunang Pilipino:", a:"Kasaysayan at Sosyolohiya", w:["Matematika","Siyensya","Dayuhang Pag-aaral"]},{q:"Bayani na sumulat ng Noli Me Tangere:", a:"Jose Rizal", w:["Andres Bonifacio","Emilio Aguinaldo","Apolinario Mabini"]},{q:"Layunin ng Pamahalaang Lokal:", a:"Maghatid ng serbisyo sa barangay", w:["Magtayo ng mall","Gumawa ng pera","Gulo"]},{q:"Pagtutulungan nang walang kapalit:", a:"Bayanihan", w:["Ma√±ana Habit","Crab Mentality","Ningas Kugon"]},{q:"Pinakamaliit na yunit ng lipunan:", a:"Pamilya", w:["Paaralan","Simbahan","Pamahalaan"]},{q:"Hunyo 12, 1898:", a:"Proklamasyon ng Kalayaan", w:["Hapon","Magellan","Martial Law"]},{q:"Pagpapahalaga sa tulong:", a:"Utang na Loob", w:["Pakikipagkapwa","Hiya","Amor Propio"]},{q:"Sangay na gumagawa ng batas:", a:"Lehislatibo", w:["Ehekutibo","Hudisyal","Militar"]},{q:"Wikang pambansa:", a:"Filipino", w:["Ingles","Kastila","Taglish"]},{q:"Tradisyon na nagbubuklod:", a:"Kultural na Pagkakakilanlan", w:["Pera","Damit","Bahay"]}],
        "Life & Career Skills": [{q:"Managing time effectively:", a:"Time Management", w:["Procrastination","Socializing","Multi-tasking"]},{q:"Ability to adapt to change:", a:"Flexibility", w:["Rigidity","Stubbornness","Fixed Mindset"]},{q:"Working for a common goal:", a:"Collaboration", w:["Competition","Individualism","Leadership"]},{q:"First step in problem-solving:", a:"Identifying the problem", w:["Ignoring","Blaming","Asking"]},{q:"Understanding others' feelings:", a:"Empathy", w:["Sympathy","Apathy","Criticism"]},{q:"Being on time:", a:"Punctuality", w:["Loudness","Dressing","Finishing"]},{q:"Main purpose of a Resume:", a:"Summarize skills/experience", w:["Hobbies","Social media","ID"]},{q:"SMART - 'A' stands for:", a:"Achievable", w:["Always","Active","Aggressive"]},{q:"Ability to lead others:", a:"Leadership", w:["Following","Quietness","Laziness"]},{q:"Maintaining positive attitude:", a:"Professionalism", w:["Arrogance","Anger","Sarcasm"]}]
    },
    "STEM Subjects": {
        "General Physics 1": [{q:"Rate of change of displacement:", a:"Velocity", w:["Speed","Acceleration","Distance"]},{q:"Tendency to resist motion change:", a:"Inertia", w:["Momentum","Force","Friction"]},{q:"Product of mass and acceleration:", a:"Force", w:["Power","Work","Energy"]},{q:"Energy due to position:", a:"Potential Energy", w:["Kinetic","Thermal","Sound"]},{q:"Force opposing motion:", a:"Friction", w:["Gravity","Tension","Magnetic"]},{q:"Acceleration of free-fall:", a:"9.8 m/s¬≤", w:["3.0 m/s¬≤","15 m/s¬≤","1.0 m/s¬≤"]},{q:"Unit of energy:", a:"Joule", w:["Newton","Watt","Pascal"]},{q:"Magnitude and direction:", a:"Vector", w:["Scalar","Constant","Integer"]},{q:"If net force is zero:", a:"Equilibrium", w:["Motion","Acceleration","Freefall"]},{q:"Motion stays in motion unless:", a:"Net Force", w:["Mass","Speed","Volume"]}],
        "General Biology": [{q:"Powerhouse of the cell:", a:"Mitochondria", w:["Ribosomes","Lysosomes","Golgi"]},{q:"Jelly-like substance:", a:"Cytoplasm", w:["Nucleus","Cell Wall","Vacuole"]},{q:"Protein synthesis site:", a:"Ribosomes", w:["ER","Nucleolus","Chloroplast"]},{q:"Organelle for photosynthesis:", a:"Chloroplast", w:["Vacuole","Mitochondria","Membrane"]},{q:"Gatekeeper of the cell:", a:"Cell Membrane", w:["Cell Wall","Cytoskeleton","Envelope"]},{q:"Eukaryotic cells feature:", a:"Have a nucleus", w:["Larger","Only DNA","Only membrane"]},{q:"Control center containing DNA:", a:"Nucleus", w:["Nucleolus","Rough ER","Smooth ER"]},{q:"Transport requiring ATP:", a:"Active Transport", w:["Passive","Diffusion","Osmosis"]},{q:"Division for growth:", a:"Mitosis", w:["Meiosis","Binary Fission","Fertilization"]},{q:"'Suicide Bag' of the cell:", a:"Lysosome", w:["Peroxisome","Vacuole","Golgi"]}],
        "General Chemistry": [{q:"Smallest particle of element:", a:"Atom", w:["Molecule","Compound","Proton"]},{q:"Definite shape and volume:", a:"Solid", w:["Liquid","Gas","Plasma"]},{q:"Horizontal rows in Periodic Table:", a:"Periods", w:["Groups","Families","Columns"]},{q:"Symbol for Gold:", a:"Au", w:["Ag","Gd","Go"]},{q:"Negative subatomic particle:", a:"Electron", w:["Proton","Neutron","Nucleolus"]},{q:"Sharing electrons bond:", a:"Covalent Bond", w:["Ionic","Metallic","Hydrogen"]},{q:"pH of 7 is:", a:"Neutral", w:["Acidic","Basic","Bitter"]},{q:"Common name for H2O:", a:"Water", w:["Salt","Methane","Peroxide"]},{q:"Center of the atom:", a:"Nucleus", w:["Shell","Orbit","Valance"]},{q:"Atomic number represents:", a:"Protons", w:["Neutrons","Electrons","Bonds"]}],
        "Earth & Space Science": [{q:"Origin of universe theory:", a:"Big Bang Theory", w:["Steady State","Nebular","Pulsating"]},{q:"The 'Red Planet':", a:"Mars", w:["Jupiter","Venus","Saturn"]},{q:"Our galaxy:", a:"Milky Way", w:["Andromeda","Sombrero","Whirlpool"]},{q:"Closest star to Earth:", a:"The Sun", w:["Proxima Centauri","Sirius","Polaris"]},{q:"Force keeping orbits:", a:"Gravity", w:["Friction","Magnetism","Inertia"]},{q:"Layer containing Ozone:", a:"Stratosphere", w:["Troposphere","Mesosphere","Exosphere"]},{q:"Moon between Earth and Sun:", a:"Solar Eclipse", w:["Lunar","Equinox","Solstice"]},{q:"Ice/dust with 'tails':", a:"Comets", w:["Meteors","Asteroids","Satellites"]},{q:"Earth revolution time:", a:"365.25 days", w:["24 hours","30 days","12 hours"]},{q:"Largest planet:", a:"Jupiter", w:["Saturn","Neptune","Uranus"]}]
    },
    "ICT & Business": {
        "Computer Programming": [{q:"Java is known for being:", a:"Platform-independent", w:["Dependent","Low-level","Hardware"]},{q:"Java source extension:", a:".java", w:[".jav",".class",".exe"]},{q:"Correct display output:", a:'System.out.println("Hello");', w:["print","echo","console.log"]},{q:"Symbol to end statement:", a:";", w:[":",",","."]},{q:"New line code:", a:'System.out.println("\\n");', w:["/n","\\t","nl"]},{q:"Output of print('A'); println('B');:", a:"AB", w:["A B","A\\nB","Error"]},{q:"Display Hello World:", a:'System.out.println("Hello World");', w:["print","log","write"]},{q:"5 + 10 result:", a:'15', w:["510","50","Error"]},{q:"1 + 2 + '3' result:", a:"33", w:["6","123","Error"]},{q:"Data container in programming:", a:"Variable", w:["Function","Loop","Class"]}],
        "Bakery Operations": [{q:"Leavening agent for bread:", a:"Yeast", w:["Baking powder","Salt","Sugar"]},{q:"Bread internal temp:", a:"200‚Äì210¬∞F", w:["180","190","220"]},{q:"Tool for flour accuracy:", a:"Kitchen scale", w:["Cup","Spoon","Rolling pin"]},{q:"Function of sugar:", a:"Sweetness and browning", w:["Leavening","Gluten","Moisture"]},{q:"Strengthens bread structure:", a:"Flour", w:["Fat","Eggs","Water"]},{q:"Storage temp (Room):", a:"20‚Äì25¬∞C", w:["0-5","30-35","50-55"]},{q:"Accurate measurement:", a:"Consistent quality", w:["Faster rise","Less sugar","Sweeter"]},{q:"Ideal proofing environment:", a:"Warm and humid", w:["Cold/dry","Hot/dry","Ventilated"]},{q:"Making dough smooth/elastic:", a:"Kneading", w:["Whisking","Folding","Sifting"]},{q:"Highest protein flour:", a:"Bread Flour", w:["Cake Flour","All-purpose","Pastry"]}],
        "Contemporary Literature": [{q:"Genre written on phones:", a:"Text Tula", w:["Blog","Flash Fiction","Hyper-poetry"]},{q:"Character of Flash Fiction:", a:"Extremely short story", w:["No ending","Long novel","Verse"]},{q:"Combines book/video/web:", a:"Digi-Fiction", w:["Manga","Doodle Fiction","E-book"]},{q:"Story via comic panels:", a:"Graphic Novel", w:["Text-talk","Hyper-poetry","Speculative"]},{q:"Japanese comic style:", a:"Manga", w:["Manhwa","Graphic Novel","Digi-fiction"]},{q:"'Blog' full name:", a:"Web Log", w:["Book","Best","Binary"]},{q:"Future/magical worlds:", a:"Speculative Fiction", w:["Non-Fiction","Biography","Memoir"]},{q:"Text-Talk Novel style:", a:"Chat logs", w:["Letters","Paragraphs","Sketches"]},{q:"Creative Non-Fiction:", a:"True story technique", w:["Fake story","Poem","Textbook"]},{q:"Performance poetry:", a:"Spoken Word", w:["Haiku","Sonnet","Text Tula"]}],
        "Politics & Governance": [{q:"Supreme law of PH:", a:"1987 Constitution", w:["Civil Code","Magna Carta","Bill of Rights"]},{q:"Enforces laws:", a:"Executive Branch", w:["Legislative","Judicial","Military"]},{q:"President's term:", a:"6 years", w:["4","8","10"]},{q:"Congress composition:", a:"Senate and House", w:["Cabinet","Supreme Court","LGU"]},{q:"Minimum voting age:", a:"18 years old", w:["15","21","16"]},{q:"Reject a bill power:", a:"Veto", w:["Pardon","Impeachment","Appointment"]},{q:"Commander-in-Chief:", a:"The President", w:["Defense Sec","Chief","Senate Pres"]},{q:"Judicial role:", a:"Interpret laws", w:["Taxes","War","Treaties"]},{q:"Smallest political unit:", a:"Barangay", w:["Municipality","Province","City"]},{q:"Election commission:", a:"COMELEC", w:["Civil Service","COA","DOJ"]}],
        "Basic Accounting": [{q:"Accounting Equation:", a:"Assets = Liabilities + Equity", w:["A=L-E","R=E","A+L=E"]},{q:"Resources owned:", a:"Assets", w:["Liabilities","Expenses","Revenues"]},{q:"Financial position report:", a:"Balance Sheet", w:["Income Statement","Cash Flow","Journal"]},{q:"Left side of an account:", a:"Debit", w:["Credit","Balance","Equity"]},{q:"Debts or obligations:", a:"Liabilities", w:["Assets","Capital","Income"]},{q:"Chronological recording:", a:"Journalizing", w:["Posting","Summarizing","Auditing"]},{q:"Providing services increases:", a:"Revenue", w:["Expense","Liability","Asset"]},{q:"Original entry book:", a:"General Journal", w:["Ledger","Worksheet","Trial"]},{q:"Goal of accounting:", a:"Decision-making info", w:["Hide money","Count staff","Ads"]},{q:"Owner withdrawal decreases:", a:"Equity", w:["Liabilities","Revenue","Debt"]}],
        "Organization & Management": [{q:"Four main functions:", a:"Planning, Organizing, Leading, Controlling", w:["Buy/Sell","Type/File","Hire/Fire"]},{q:"Setting goals:", a:"Planning", w:["Controlling","Staffing","Budgeting"]},{q:"SWOT - 'T' stands for:", a:"Threats", w:["Time","Team","Tasks"]},{q:"Decision-making (no consultation):", a:"Autocratic", w:["Democratic","Laissez-faire","Participative"]},{q:"Top-level role:", a:"Long-term vision", w:["Daily supervision","Hiring","Repairs"]},{q:"Monitoring performance:", a:"Controlling", w:["Planning","Brainstorming","Marketing"]},{q:"Recruiting employees:", a:"Staffing", w:["Leading","Accounting","Organizing"]},{q:"'Hands-off' style:", a:"Laissez-faire", w:["Dictatorial","Democratic","Bureaucratic"]},{q:"Company purpose summary:", a:"Mission Statement", w:["Salary list","Office map","Secret code"]},{q:"SWOT - 'W' stands for:", a:"Weaknesses", w:["Work","Wealth","Win"]}]
    }
};

let db = JSON.parse(localStorage.getItem('q_db')) || FULL_DB;
let peer, conn, connections = [], curSub = '', curCat = '', qIdx = 0, score = 0, activeQs = [], currentUname = '';
let manualGame = { name: 'Pizza', theme: '' };

function nav(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'view-dash') renderFolders();
}

function addFolder() {
    const c = document.getElementById('new-cat').value, s = document.getElementById('new-sub').value;
    if(c && s) { if(!db[c]) db[c] = {}; db[c][s] = []; save(); renderFolders(); }
}

function renderFolders() {
    const list = document.getElementById('folder-list'); list.innerHTML = '';
    Object.keys(db).forEach(cat => {
        Object.keys(db[cat]).forEach(sub => {
            const item = document.createElement('div');
            item.className = 'list-item';
            item.onclick = () => openEditor(cat, sub);
            item.innerHTML = `<span><strong>${sub}</strong> (${cat})</span><button class="del-btn" onclick="event.stopPropagation(); delSub('${cat}','${sub}')">‚úï</button>`;
            list.appendChild(item);
        });
    });
}

function delSub(c, s) { if(confirm("Delete Folder?")) { delete db[c][s]; save(); renderFolders(); } }
function openEditor(cat, sub) { curCat = cat; curSub = sub; document.getElementById('edit-title').innerText = sub; refreshQList(); nav('view-edit'); }

function refreshQList() {
    const ql = document.getElementById('q-list'); ql.innerHTML = '';
    db[curCat][curSub].forEach((q, i) => {
        const type = (!q.w || q.w[0] === "") ? "[ID]" : "[MC]";
        ql.innerHTML += `<div class="list-item"><span>${type} ${q.q}</span><div style="display:flex;gap:5px;"><button onclick="editQ(${i})">‚úèÔ∏è</button><button onclick="delQ(${i})">‚úï</button></div></div>`;
    });
}

function delQ(i) { db[curCat][curSub].splice(i, 1); save(); refreshQList(); }

function editQ(i) {
    const q = db[curCat][curSub][i];
    document.getElementById('add-q').value = q.q;
    document.getElementById('add-a').value = q.a;
    document.getElementById('add-w').value = q.w ? q.w.join(',') : '';
    db[curCat][curSub].splice(i, 1);
    refreshQList();
}

function saveQuestion() {
    const q = document.getElementById('add-q').value, a = document.getElementById('add-a').value, w = document.getElementById('add-w').value;
    if(q && a) {
        db[curCat][curSub].push({q, a, w: w ? w.split(',').map(x => x.trim()) : [""]});
        save(); refreshQList();
        document.getElementById('add-q').value = ''; document.getElementById('add-a').value = ''; document.getElementById('add-w').value = '';
    }
}

function save() { localStorage.setItem('q_db', JSON.stringify(db)); }
function setManualGame(n, t) { manualGame = { name: n, theme: t }; document.getElementById('main-shell').className = "app-shell " + t; }

function launchGame() {
    const code = document.getElementById('host-code').value;
    if(!code) return alert("Code!");
    peer = new Peer('q-' + code);
    peer.on('open', () => { nav('view-lobby'); document.getElementById('room-display').innerText = "ROOM: " + code; });
    peer.on('connection', c => {
        c.on('open', () => { document.getElementById('live-results').innerHTML += `<tr id="row-${c.peer}"><td>NEW STUDENT</td><td style="text-align:right">...</td></tr>`; });
        c.on('data', d => { if(d.type==='res') document.getElementById(`row-${c.peer}`).innerHTML = `<td>${d.name}</td><td style="text-align:right"><strong>${d.score}/${d.total}</strong></td>`; });
        connections.push(c);
    });
}

function joinGame() {
    const code = document.getElementById('stu-code').value, name = document.getElementById('stu-name').value || "Guest";
    currentUname = name;
    peer = new Peer();
    peer.on('open', () => {
        conn = peer.connect('q-' + code);
        conn.on('open', () => { nav('view-arena'); });
        conn.on('data', d => { if(d.type==='start') { activeQs = d.qs; manualGame = d.game; startQuiz(); }});
    });
}

function signalStart() { connections.forEach(c => c.send({type:'start', qs: db[curCat][curSub], game: manualGame})); }

function startQuiz() { qIdx = 0; score = 0; document.getElementById('main-shell').className = "app-shell " + manualGame.theme; showQ(); }

function showQ() {
    updateVisual();
    if(qIdx >= activeQs.length) { 
        conn.send({type:'res', name:currentUname, score:score, total:activeQs.length}); 
        nav('view-result'); 
        document.getElementById('final-score').innerText = `${score}/${activeQs.length}`; 
        return; 
    }
    const q = activeQs[qIdx];
    document.getElementById('q-text').innerText = q.q;
    document.getElementById('p-bar').style.width = (qIdx/activeQs.length)*100 + "%";
    
    const grid = document.getElementById('opt-grid');
    const iz = document.getElementById('input-zone');
    
    if(!q.w || q.w[0] === "") {
        grid.style.display = 'none';
        iz.style.display = 'block';
        document.getElementById('ident-input').value = '';
    } else {
        grid.style.display = 'grid';
        iz.style.display = 'none';
        grid.innerHTML = '';
        let opts = [q.a, ...q.w].sort(() => Math.random() - 0.5);
        opts.forEach(o => {
            const b = document.createElement('button'); b.className = 'opt-btn'; b.innerText = o;
            b.onclick = () => { if(o === q.a) score++; qIdx++; showQ(); };
            grid.appendChild(b);
        });
    }
}

function submitIdent() {
    const userAns = document.getElementById('ident-input').value.trim().toLowerCase();
    const correctAns = activeQs[qIdx].a.toLowerCase();
    if(userAns === correctAns) score++;
    qIdx++;
    showQ();
}

function updateVisual() {
    const canvas = document.getElementById('game-canvas');
    const toppings = ['üçï','üçÑ','üçÖ','ü•ì','üßÄ','ü•¨'];
    canvas.innerText = (manualGame.name === 'Pizza') ? toppings[score % toppings.length] : (manualGame.name === 'Power' ? 'üîã' : '‚òÄÔ∏è');
}
</script>
</body>
</html>

